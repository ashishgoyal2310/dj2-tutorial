<!DOCTYPE html>
<html lang="en">
<head>
  <title>Tracker</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
</head>
<body>

<div class="jumbotron text-center">
  <h1>Download Tracker</h1>
  <p>Resize this responsive page to see the effect!</p>
</div>

<div class="container">
    <ul class="nav nav-tabs">
        <li class="active"><a data-toggle="tab" href="#id_download_link">Download</a></li>
        <li><a data-toggle="tab" href="#download_link_list">List</a></li>
        <li><a data-toggle="tab" href="#download_link_status">Status</a></li>
    </ul>
    <div class="tab-content">
        <div id="id_download_link" class="tab-pane fade in active">
            <h3>Download</h3>
            <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.</p>
            <div class="row">
                <div class="form-group col-xs-4">
                    <input type="text" class="form-control" id="id_download_link_inpt">
                </div>
                <input type="button" class="btn btn-info" id="id_download_link_btn" value="Download">
            </div>
            <div class="row">
                <div class="col-xs-12">
                    <pre class="panel-body"><code></code></pre>
                </div>
            </div>
        </div>
        <div id="download_link_list" class="tab-pane fade">
            <h3>List</h3>
            <p>Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</p>
            <div id="id-section" role="tablist" aria-multiselectable="true">

             {% for tracker_task_id in tracker_task_ids %}
                <div class="panel panel-default">
                    <div class="panel-heading" role="tab">
                        <h5 class="panel-title">
                            <a href="#id-panel-to-toggle-{{ tracker_task_id }}" class="download-link-list-cls" data-toggle="collapse-remove" data-parent="#id-section" data-trackid="{{ tracker_task_id }}" aria-expanded="false" aria-controls="id-panel-to-toggle-{{ tracker_task_id }}">{{ tracker_task_id }}</a>
                        </h5>
                    </div>
                    <div id="id-panel-to-toggle-{{ tracker_task_id }}" class="panel-collapse collapse" role="tabpanel">
                        <div class="panel-body">
                            Response...
                            <pre></pre>
                        </div>
                    </div>
                </div>
             {% endfor  %}

            </div>
        </div>
        <div id="download_link_status" class="tab-pane fade">
            <h3>Status</h3>
            <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.</p>
            <div class="row">
                <div class="form-group col-xs-4">
                    <input type="text" class="form-control" id="id_task">
                </div>
                <input type="button" class="btn btn-info" id="id_check_btn" value="Check">
            </div>
            <div class="row">
                <div class="col-sm-12">
                    <table class="table" id="id_task_status_tbl">
                        <thead>
                          <tr>
                            <th>Task Id</th>
                            <th>Total Size</th>
                            <th>Downloaded Size</th>
                            <th>Pending Size</th>
                            <th>Status</th>
                            <th>Name</th>
                          </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).on('click', '#id_download_link_btn', function (eve) {
        download_link_tab_ele = $('#id_download_link');
        var download_link_url = download_link_tab_ele.find('#id_download_link_inpt').val();
        if (!download_link_url) return false;

        var ajaxUrl = '/api/trackers/';
        var data = {
            'fileurl': download_link_url,
        }

        $.ajax({
            async: true,
            type: "POST",
            dataType : "json",
            contentType: "application/json; charset=utf-8",
            data : JSON.stringify(data),
            url: ajaxUrl,
            success: function (response) {
                download_link_tab_ele.find('.panel-body').html(JSON.stringify(response, undefined, 4))
            },
            error: function (xhr, error, err) {
                var responseJSON = xhr.responseJSON;
                download_link_tab_ele.find('.panel-body').html(JSON.stringify(responseJSON, undefined, 4));

                if (xhr.status === 400 && responseJSON) {
                    console.log(responseJSON);
                } else {
                    alert(err);
                }
            }
        });
    });
    $(document).on('click', '.download-link-list-cls', function (eve) {
        panel_ele = $(eve.target).parents('.panel-default');
        response_panel_ele = panel_ele.find('.panel-collapse');

        // close all response panel
        $('.panel-collapse').removeClass('in');
        response_panel_ele.addClass('in');

        var trackID = $(eve.target).data('trackid');
        if (!trackID) return false;

        var ajaxUrl = '/api/trackers/' + trackID + '/';

        $.ajax({
            async: true,
            type: "GET",
            dataType : "json",
            url: ajaxUrl,
            success: function (response) {
                var responseJSON = JSON.stringify(response, undefined, 4);
                response_panel_ele.find('.panel-body pre').html(responseJSON);
            },
            error: function (xhr, error, err) {
                var responseJSON = xhr.responseJSON;
                responseJSON = JSON.stringify(responseJSON, undefined, 4);

                if (xhr.status === 400 && responseJSON) {
                    response_panel_ele.find('.panel-body pre').html(responseJSON);
                } else {
                    response_panel_ele.find('.panel-body pre').html(err);
                }
            }
        });
    });
    $(document).on('click', '#id_check_btn', function (eve) {
        task_id = $('#id_task').val();
        if (!task_id) return false;
        var ajaxUrl = '/api/trackers/'+ task_id +'/';

        $.ajax({
            async: true,
            type: "GET",
            url: ajaxUrl,
            success: function (response) {
                var task_id = response.task_id;
                var ele_class_name = task_id + '_cls';

                var percentDownloaded = response.total_size ? ((response.downloaded_size / response.total_size) * 100).toFixed(2) : 0;
                var statusEle = response.state +
                                '<div class="progress"> ' +
                                '<div class="progress-bar" role="progressbar" aria-valuenow="'+ percentDownloaded +'" aria-valuemin="0" aria-valuemax="100" style="width: '+ percentDownloaded +'%;"> '+ percentDownloaded +'% </div> '+
                                '</div>';

                var htmlTdChildEle = ''+
                        '<td>'+ task_id +'</td>'+
                        '<td>'+ response.total_size +'</td>'+
                        '<td>'+ response.downloaded_size +'</td>'+
                        '<td>'+ response.pending_size +'</td>'+
                        '<td>'+ statusEle +'</td>'+
                        '<td>'+ response.file_name  +'</td>'

                if ($('.'+ele_class_name).length) {
                    $('.'+ele_class_name).html(htmlTdChildEle);
                } else {
                    var htmlEle = ''+
                        '<tr class="'+ ele_class_name +'">' +
                        htmlTdChildEle +
                        '</tr>';
                    $('table#id_task_status_tbl tbody').append(htmlEle);
                }

            },
            error: function (xhr, error, err) {
                alert(err);
            }
        });
    });
</script>

</body>
</html>
